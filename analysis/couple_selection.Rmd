---
title: "Couple selection in UKBB"
author: "jennysjaarda"
date: "2021-09-08"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, include = FALSE}

options(scipen=999)
source("code/settings.R")
library(targets)
library(dplyr)

```

```{r load_targets, include = FALSE, eval = ifelse(Sys.info()["sysname"]=="Linux", TRUE, FALSE)}

tar_load(data_main_UKBB_raw_count)
tar_load(data_id_age)
tar_load(hh_pairs)
tar_load(hh_pairs_kin)
tar_load(data_household_relationships)

```


**Couples were defined and selected according to the following scheme**

# UKBB full sample 

The initial UKBB sample comprised of N = **`r data_main_UKBB_raw_count`** individuals. 

# European, genetic, consenting sample 

Each phenotype in the SGG database was filtered for the following criteria based on the genetic qc file (located here: ``r files_ref %>% filter(custom_names == "sqc") %>% pull(files)``): 

- `excess.relatives=0`
- `putative.sex.chromosome.aneuploidy=0`
- `in.white.british.ancestry.subset==1`

Redacted samples and participants that removed consent were also excluded. Specifically, redacted samples are any IDs in `c(-1, -2, -3)`, from the same genetic QC sample and the samples which removed consent, according to the exclusion file `w16389_20200204.csv`.

After filtering, N = **`r dim(data_id_age)[1]`** individuals remained. 

***A few notes on the PHESANT processing:***

- Raw phenotypes in the SGG database were processed according the the `PHESANT` pipeline. 
- For details on the processing by PHESANT see: https://github.com/astheeggeggs/PHESANT. 
- The pipeline is not the simplest to follow and does a lot of referring to other variables and has been modified slightly based on the data we have. 
- The main thing to note is all continuous variables were transformed to a normal distribution using an inverse normal rank transformation.
- Each phenotype file contains ID, age, and sex columns (the first 3).
- Note that this filtering procedure does not necessarily remove related individuals. For this, please use the function 'ukb_gen_samples_to_remove()' from the [UKBB r-package](https://cran.r-project.org/web/packages/ukbtools/vignettes/explore-ukb-data.html).

# Houshold pairs

Within the European, genetic, consenting sample, we limited to only individuals which came from households with exactly two participants in the UKBB based on the file: ``r files_ref %>% filter(custom_names == "household_info") %>% pull(files)``.

```{r, hh_pairs_filtering1, include=FALSE}
## the `hh_pairs` target includes all UKBB participants so is not a direct subset of the filter above, so we need to first remove people that are not in the PHESANT files to know how many pairs are in this sample (PHESANT files have already been filtered as above)


pairs <- hh_pairs_kin
household_relationships <- data_household_relationships
field <- household_relationships_field

pairs$sex1 <- household_relationships[["sex"]][match(pairs[["HOUSEHOLD_MEMBER1"]], household_relationships$userId)]
pairs$sex2 <- household_relationships[["sex"]][match(pairs[["HOUSEHOLD_MEMBER2"]], household_relationships$userId)]

#merge(pairs, household_relationships, by.x=, by.y=)
pairs_full_sex <- pairs[which(!is.na(pairs$sex1) & !is.na(pairs$sex2)),]
pairs_not_full_sex <- pairs[which(!(!is.na(pairs$sex1) & !is.na(pairs$sex2))),]

```

After filtering, N = **`r dim(pairs_full_sex)[1]*2`** individuals and N = **`r dim(pairs_full_sex)[1]`** couples remained. 

# Unrelated pairs 

Household couples defined above were filtered based on kinship (estimate of the kinship coefficient for pair based on the set of markers used in the kinship inference) from the following file: ``r files_ref %>% filter(custom_names == "relatives") %>% pull(files)``. Couples were excluded if kinship was > `0.05`. 

```{r, hh_pairs_filtering2, include=FALSE}

pairs_unrelated <- subset(pairs_full_sex, pairs_full_sex$kinship<0.05)

```

After filtering for relatedness, N = **`r dim(pairs_unrelated)[1]*2`** individuals and N = **`r dim(pairs_unrelated)[1]`** couples remained. 

# Heterosexual pairs 

Unrelated, household pairs were filtered to only include heterosexual couples. 

```{r, hh_pairs_filtering3, include=FALSE}

pairs_unrelated_hetero <- pairs_unrelated[-which(pairs_unrelated$sex1==pairs_unrelated$sex2),]
pairs_unrelated_hetero2 <- pairs_unrelated_hetero[-which(is.na(pairs_unrelated_hetero$sex1) | is.na(pairs_unrelated_hetero$sex2)),]

temp1 <- pairs_unrelated_hetero[which(pairs_unrelated_hetero$sex1==0),c("HOUSEHOLD_MEMBER2", "HOUSEHOLD_MEMBER1", "HOUSE_ID", "kinship", "sex2", "sex1", "tar_group")]

colnames(temp1) <- colnames(pairs_unrelated_hetero)

temp2 <- pairs_unrelated_hetero[which(pairs_unrelated_hetero$sex1==1),c("HOUSEHOLD_MEMBER1", "HOUSEHOLD_MEMBER2", "HOUSE_ID", "kinship", "sex1", "sex2", "tar_group")]
pairs_filter <- rbind(temp2, temp1)
## 79150      6

```

After removing homosexual pairs, N = **`r dim(pairs_filter)[1]*2`** individuals and N = **`r dim(pairs_filter)[1]`** couples remained. 

# Couple pairs

Finally, using the data at data-field `6141`, ["How are people in household related to participant"](https://biobank.ctsu.ox.ac.uk/showcase/field.cgi?id=6141), the heterosexual, unrelated, household pairs were filtered to only include couples who both responded `Husband, wife, or partner`. 

```{r hh_pairs_filtering4,  include = FALSE}

pairs_filter$house_rel_member1 <- household_relationships[[field]][match(pairs_filter[["HOUSEHOLD_MEMBER1"]], household_relationships$userId)]
pairs_filter$house_rel_member2 <- household_relationships[[field]][match(pairs_filter[["HOUSEHOLD_MEMBER2"]], household_relationships$userId)]
pairs_filter2 <- pairs_unrelated_hetero[which(pairs_filter$house_rel_member1==TRUE & pairs_filter$house_rel_member2==TRUE ) ,]
## 75048     6


colnames(pairs_filter2)[which(colnames(pairs_filter2)=="sex1")] <- "HOUSEHOLD_MEMBER1_sex"
colnames(pairs_filter2)[which(colnames(pairs_filter2)=="sex2")] <- "HOUSEHOLD_MEMBER2_sex"


```

After removing non-romantic pairs, N = **`r dim(pairs_filter2)[1]*2`** individuals and N = **`r dim(pairs_filter2)[1]`** couples remained. 


