---
title: "Update Meeting: 14-06-2021"
author: "Jenny Sjaarda"
date: "2021-06-14"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
  toc: true
---


```{r setup, include = FALSE}

options(scipen=999)
source("code/settings.R")
source("R/functions.R")
library(DT)
library(knitr)
library(targets)

```

```{r load_targets, include = FALSE, eval = ifelse(Sys.info()["sysname"]=="Linux", TRUE, FALSE)}

tar_load(traits_final)
tar_load(household_MR_binned_het)
tar_load(traits_corr2_filled)

```

# Last week summary.

## Getting back up to speed. 

- Project had been dormant for > 1 year. 
- Since then, one key paper has been published in Nature Communications by Tenesa et al: [Evidence of horizontal indirect genetic effects in humans](https://www.nature.com/articles/s41562-020-00991-9).
- Discussed where we left off and how to build on Tenesa paper.
- Slides can be found [here](presentations/Xia_horizontal_genetic_effects/presentation.html#1).

## Next steps: 

1. Summarize all our results to get a feel for top traits (let's call this: trait/trait MR). A logical addition that we didn't discuss would be to meta-analyze across sexes and see what traits are significant in pooled analysis and then check which of these are significantly different between sexes.

2. Test linear association across bins (both age and time-together bins) using IVW estimated inversely weighted by SE. 

3. Combine age and time-together bins into a grid of effect sizes to see if we see any pattern. 

4. Move beyond our trait/trait MR into investigating how one trait impacts other traits to tease out direct vs indirect effects, two parts here:
    (a) as univariate model and 
    (b) as multivariate model (selecting traits for multivariate model that were nominal in univariate).
    
5. Replicate permutation procedure from Tenesa paper. Do you still want to explore this?

6. Explore dietary traits - request estimates from Ninon? 

## Follow-up questions:

Re (#4), for the trait/trait MR, I essentially followed a 2-sample MR procedure (just as a refresher for us both), so for example BMI partner vs BMI trait: 

- Find IVs for BMI in Neale and take these estimates as betaX.
- Test association of IVs with partner BMI in couples (this is betaY). 
- Combine effects together in standard MR framework (betaY ~ betaX). 

For the univariate analysis between two traits, I think what you were suggesting is to follow exactly the same procedure as above. So for example, disease partner vs BMI trait: 

- Same IVs as above and take these estimates as betaX.
- Test association of these IVs with partner "different phenotype" (some disease, let's say) (betaY). 
- Combine in MR framework. 

For the multivariate model, so if the model of interest is BMI ~ BMI + education + diet + activity level: 

- IVs are the union of the IVs for each individual trait (estimates taken from Neale: beta_BMI, beta_edu, beta_diet). 
- **Additional step**: prune these SNPs to ensure independence.
- Test association of these pruned SNPs with BMI in couples (betaY). 
- Combine effects in multivariate MR framework: betaY ~ beta_BMI + beta_edu + beta_diet, etc... 

Does this look right (particularly for the multivariate model)? i.e. the final MR model only includes beta estimates, no raw genetic data. 

I also understood that one of the traits to explore would be PCs. To me it seems logical that this would be a causal variable to explore (for eg, an MR being: BMI_beta ~ PCX_beta) rather than the other way around. If I have that right, then that means we would need IVs for PCs. At quick glance, Neale doesn't have this available. Do you know if anyone in the group would have done this, otherwise I should run this GWAS. 

## Responses:

- Re. #3: also test heterogeneity (in case there is discrepancy, but no trend), using Cochran's Q stat.
- Re. combining time-together  and age bins: Do this only if the previous point gave something promising. Otherwise drop it. 
- Not urgent to replicate Tenesa paper.
- To explore dietary traits, got in touch again with Nicola Pirastu.
- Raw genetic data is only used to derive the betaY, but from then it is a 2-sample MR.
-  PCs are only exposures, not outcomes. Need to run GWAS. 

# Results.

## Traits analyzed.

```{r traits, echo = FALSE, eval = ifelse(Sys.info()["sysname"]=="Linux", TRUE, FALSE)}

traits_final.DT <- traits_final %>% as_tibble() %>% mutate(r = sqrt(as.numeric(r2))) %>% dplyr::select(Neale_pheno_ID, description, variable_type, category, N_pairs, r2, r, num_IVs, num_IVs_pass_het)
DT::datatable(traits_final.DT, width = "100%") %>% formatRound(columns=c('r2', 'r'), digits = 3)

```

## Summary of AM MR results

- IVW estimates report sex-specific results
- MR_meta statistics refer to the meta of both-sexes combined. 
- Sex heterogeneity column reports the p-value of the difference between the MR estimates from the two sexes.

```{r sex_het, echo = FALSE, eval = ifelse(Sys.info()["sysname"]=="Linux", TRUE, FALSE)}


AM_result <- household_MR_binned_het %>% filter(same_trait)
reduced_mr_summary <- AM_result %>% dplyr::select("exposure_ID", "exposure_sex","IVW_beta","IVW_pval", 
                                                        "IVW_meta_beta", "IVW_meta_pval", "sex_het_pval")


reduced_mr_summary.DT <- replace_Neale_ID(reduced_mr_summary, traits_corr2_filled, "exposure_ID", "description")

DT::datatable(reduced_mr_summary.DT, width = "100%") %>% formatRound(columns=c('IVW_beta', 'IVW_pval', 'IVW_meta_beta', 'IVW_meta_pval', 'sex_het_pval'), digits = 3)

```


## Testing discrepancy amongst bins.

- The first table represents the results of individuals binned by average age. 
- The second table represent the results of individuals binned by time together.
- Q p-values report the difference amongst bins.

```{r mr_summary_age, echo = FALSE, eval = ifelse(Sys.info()["sysname"]=="Linux", TRUE, FALSE)}

mr_summary_age_reduced <- AM_result %>% dplyr::filter(grouping_var == "age_even_bins") %>% dplyr::select(exposure_ID, exposure_sex, grouping_var, Q_pval, Q_pval_meta)
mr_summary_age_reduced.DT <- replace_Neale_ID(mr_summary_age_reduced, traits_corr2_filled, "exposure_ID", "description")

DT::datatable(mr_summary_age_reduced.DT, width = "100%") %>% formatRound(columns=c('Q_pval', 'Q_pval_meta'), digits = 3)


mr_summary_tt_reduced <- AM_result %>% dplyr::filter(grouping_var == "time_together_even_bins") %>% dplyr::select(exposure_ID, exposure_sex, grouping_var, Q_pval, Q_pval_meta)
mr_summary_tt_reduced.DT <- replace_Neale_ID(mr_summary_tt_reduced, traits_corr2_filled, "exposure_ID", "description")

DT::datatable(mr_summary_tt_reduced.DT, width = "100%") %>% formatRound(columns=c('Q_pval', 'Q_pval_meta'), digits = 3)

```


